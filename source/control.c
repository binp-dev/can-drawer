#include <stdio.h>
#include <signal.h>
#include <math.h>
#include <pthread.h>

#include <candev/node.h>
#include <candev/kozak.h>

#include "curve.h"

#define __REALTIME__
//#define __PRINT__

const float svg[] = {
18.342000, 17.683000, 18.305000, 18.449000, 18.815000, 18.849000, 19.434000, 19.103000,
17.795000, 16.411000, 17.795000, 16.411000, 18.378000, 16.918000, 18.342000, 17.683000,
17.831000, 13.353000, 18.305000, 14.736000, 17.795000, 16.411000, 17.795000, 16.411000,
14.592000, 8.075000, 15.793000, 9.749000, 17.358000, 11.968000, 17.831000, 13.353000,
13.320000, 1.996000, 14.411000, 4.470000, 13.393000, 6.400000, 14.592000, 8.075000,
7.860000, 0.723000, 9.389000, -0.333000, 12.227000, -0.478000, 13.320000, 1.996000,
6.875000, 5.637000, 6.803000, 4.397000, 6.330000, 1.777000, 7.860000, 0.723000,
6.767000, 8.074000, 6.908000, 7.754000, 6.948000, 6.873000, 6.875000, 5.637000,
4.983000, 10.550000, 5.639000, 9.568000, 6.623000, 8.394000, 6.767000, 8.074000,
3.380000, 14.408000, 3.855000, 13.571000, 4.328000, 11.532000, 4.983000, 10.550000,
3.235000, 16.009000, 3.235000, 16.009000, 2.907000, 15.245000, 3.380000, 14.408000,
2.652000, 16.666000, 2.907000, 16.117000, 3.235000, 16.009000, 3.235000, 16.009000,
0.978000, 17.645000, 1.888000, 17.465000, 2.397000, 17.210000, 2.652000, 16.666000,
0.286000, 19.067000, 0.068000, 18.412000, 0.068000, 17.827000, 0.978000, 17.645000,
0.032000, 20.922000, 0.287000, 20.087000, 0.505000, 19.721000, 0.286000, 19.067000,
2.288000, 22.157000, 1.051000, 22.014000, -0.223000, 21.757000, 0.032000, 20.922000,
6.075000, 23.250000, 4.909000, 23.105000, 3.526000, 22.304000, 2.288000, 22.157000,
7.603000, 22.450000, 7.603000, 22.450000, 7.238000, 23.396000, 6.075000, 23.250000,
10.295000, 22.123000, 8.913000, 22.157000, 7.603000, 22.450000, 7.603000, 22.450000,
12.987000, 22.414000, 12.987000, 22.414000, 11.679000, 22.086000, 10.295000, 22.123000,
13.715000, 23.250000, 13.242000, 22.996000, 12.987000, 22.414000, 12.987000, 22.414000,
15.863000, 22.852000, 15.208000, 23.542000, 14.189000, 23.505000, 13.715000, 23.250000,
19.248000, 20.740000, 18.266000, 21.287000, 16.519000, 22.159000, 15.863000, 22.852000,
19.434000, 19.103000, 20.053000, 19.356000, 20.233000, 20.192000, 19.248000, 20.740000,
12.044000, 4.434000, 12.044000, 3.671000, 11.540000, 3.052000, 10.916000, 3.052000,
11.422000, 5.670000, 11.791000, 5.443000, 12.044000, 4.976000, 12.044000, 4.434000,
11.124000, 5.542000, 11.229000, 5.587000, 11.328000, 5.629000, 11.422000, 5.670000,
11.504000, 4.819000, 11.504000, 5.149000, 11.346000, 5.432000, 11.124000, 5.542000,
10.909000, 4.040000, 11.238000, 4.040000, 11.504000, 4.389000, 11.504000, 4.819000,
10.317000, 4.819000, 10.317000, 4.390000, 10.584000, 4.040000, 10.909000, 4.040000,
10.420000, 5.256000, 10.355000, 5.131000, 10.317000, 4.978000, 10.317000, 4.819000,
9.907000, 5.054000, 10.047000, 5.107000, 10.226000, 5.179000, 10.420000, 5.256000,
9.788000, 4.434000, 9.788000, 4.658000, 9.831000, 4.868000, 9.907000, 5.054000,
10.916000, 3.052000, 10.292000, 3.052000, 9.788000, 3.671000, 9.788000, 4.434000,
11.458000, 6.478000, 11.494000, 6.277000, 11.147000, 6.074000, 10.835000, 5.966000,
10.835000, 6.938000, 11.257000, 6.680000, 11.421000, 6.680000, 11.458000, 6.478000,
9.203000, 7.799000, 9.496000, 7.762000, 10.412000, 7.194000, 10.835000, 6.938000,
8.432000, 7.470000, 8.744000, 7.671000, 8.908000, 7.836000, 9.203000, 7.799000,
7.681000, 6.534000, 7.533000, 6.789000, 8.120000, 7.268000, 8.432000, 7.470000,
8.339000, 6.001000, 8.138000, 6.184000, 7.681000, 6.534000, 7.681000, 6.534000,
9.367000, 5.435000, 9.055000, 5.378000, 8.541000, 5.817000, 8.339000, 6.001000,
10.835000, 5.966000, 10.523000, 5.856000, 9.679000, 5.488000, 9.367000, 5.435000,
8.914000, 4.580000, 8.914000, 3.857000, 8.514000, 3.271000, 8.022000, 3.271000,
8.876000, 4.955000, 8.901000, 4.836000, 8.914000, 4.713000, 8.914000, 4.580000,
8.516000, 5.162000, 8.634000, 5.062000, 8.756000, 4.996000, 8.876000, 4.955000,
8.352000, 5.303000, 8.403000, 5.257000, 8.456000, 5.211000, 8.516000, 5.162000,
8.426000, 4.730000, 8.461000, 4.949000, 8.430000, 5.157000, 8.352000, 5.303000,
7.836000, 4.088000, 8.097000, 4.047000, 8.360000, 4.335000, 8.426000, 4.730000,
7.485000, 4.885000, 7.419000, 4.488000, 7.576000, 4.133000, 7.836000, 4.088000,
8.074000, 5.527000, 7.814000, 5.570000, 7.552000, 5.282000, 7.485000, 4.885000,
8.118000, 5.515000, 8.103000, 5.520000, 8.089000, 5.524000, 8.074000, 5.527000,
7.755000, 5.831000, 7.874000, 5.742000, 7.991000, 5.637000, 8.118000, 5.515000,
7.131000, 4.579000, 7.131000, 5.167000, 7.395000, 5.664000, 7.755000, 5.831000,
8.022000, 3.271000, 7.530000, 3.271000, 7.131000, 3.856000, 7.131000, 4.579000,
6.334000, 22.563000, 6.334000, 22.563000, 6.945000, 22.184000, 7.061000, 21.662000,
3.542000, 21.776000, 4.240000, 22.069000, 5.780000, 22.737000, 6.334000, 22.563000,
0.837000, 21.139000, 1.070000, 21.397000, 2.845000, 21.487000, 3.542000, 21.776000,
1.042000, 19.743000, 0.953000, 20.294000, 0.606000, 20.875000, 0.837000, 21.139000,
0.954000, 18.462000, 0.868000, 18.841000, 1.128000, 19.188000, 1.042000, 19.743000,
2.611000, 17.824000, 2.176000, 18.085000, 1.042000, 18.085000, 0.954000, 18.462000,
3.484000, 16.602000, 3.135000, 16.805000, 3.048000, 17.561000, 2.611000, 17.824000,
4.734000, 17.533000, 4.472000, 17.124000, 3.833000, 16.397000, 3.484000, 16.602000,
6.391000, 20.120000, 5.984000, 19.684000, 4.995000, 17.938000, 4.734000, 17.533000,
7.061000, 21.662000, 7.177000, 21.140000, 6.799000, 20.556000, 6.391000, 20.120000,
13.393000, 18.957000, 13.393000, 18.957000, 13.393000, 17.103000, 13.498000, 16.590000,
10.516000, 20.776000, 12.265000, 20.520000, 13.393000, 18.957000, 13.393000, 18.957000,
7.895000, 20.848000, 7.895000, 20.848000, 8.769000, 21.032000, 10.516000, 20.776000,
6.913000, 19.721000, 6.913000, 19.721000, 7.895000, 20.848000, 7.895000, 20.848000,
7.568000, 18.846000, 7.676000, 19.610000, 6.913000, 19.721000, 6.913000, 19.721000,
4.838000, 16.079000, 5.239000, 17.026000, 7.458000, 18.082000, 7.568000, 18.846000,
5.276000, 12.730000, 4.766000, 13.531000, 4.439000, 15.134000, 4.838000, 16.079000,
6.621000, 9.600000, 6.111000, 10.184000, 5.785000, 11.930000, 5.276000, 12.730000,
7.348000, 7.235000, 7.530000, 7.782000, 7.131000, 9.020000, 6.621000, 9.600000,
9.203000, 8.329000, 8.440000, 8.546000, 7.348000, 7.235000, 7.348000, 7.235000,
11.933000, 7.055000, 11.680000, 6.835000, 9.967000, 8.110000, 9.203000, 8.329000,
14.588000, 13.606000, 14.371000, 12.077000, 12.187000, 7.274000, 11.933000, 7.055000,
14.442000, 16.298000, 14.442000, 16.298000, 14.807000, 15.134000, 14.588000, 13.606000,
13.498000, 16.590000, 13.606000, 16.080000, 14.442000, 16.298000, 14.442000, 16.298000,
16.285000, 21.691000, 16.852000, 21.095000, 18.744000, 20.331000, 19.084000, 20.019000,
14.533000, 22.623000, 14.984000, 22.763000, 15.721000, 22.282000, 16.285000, 21.691000,
13.882000, 20.953000, 13.684000, 21.859000, 14.079000, 22.480000, 14.533000, 22.623000,
14.222000, 18.494000, 14.250000, 19.060000, 14.079000, 20.050000, 13.882000, 20.953000,
14.222000, 17.050000, 14.079000, 17.163000, 14.194000, 17.928000, 14.222000, 18.494000,
14.588000, 16.995000, 14.588000, 16.995000, 14.363000, 16.940000, 14.222000, 17.050000,
15.126000, 18.353000, 14.477000, 18.068000, 14.588000, 16.995000, 14.588000, 16.995000,
16.992000, 17.955000, 16.709000, 18.240000, 15.775000, 18.633000, 15.126000, 18.353000,
17.474000, 17.250000, 17.474000, 17.250000, 17.276000, 17.674000, 16.992000, 17.955000,
17.728000, 17.844000, 17.756000, 17.393000, 17.474000, 17.250000, 17.474000, 17.250000,
18.351000, 19.173000, 17.925000, 18.948000, 17.700000, 18.296000, 17.728000, 17.844000,
19.084000, 20.019000, 19.424000, 19.709000, 18.774000, 19.396000, 18.351000, 19.173000
};

long get_ns_diff(const struct timespec *ts, const struct timespec *lts) {
	return 1000000000*(ts->tv_sec - lts->tv_sec) + ts->tv_nsec - lts->tv_nsec;
}

int main(int argc, char *argv[]) {
	int i, j;
	int status;
	int done = 0;
	CAN_Node node;
	KOZ dev;
	
	//signal(SIGTERM, sig_handler);
	//signal(SIGINT, sig_handler);
	
	const char *ifname;
#ifdef __XENO__
	ifname = "rtcan0";
#else
	ifname = "can0";
#endif
	status = CAN_createNode(&node, ifname);
	if(status != 0)
		return 1;

	printf("Node created\n");
	
	KOZ_setup(&dev, 0x0F, &node);
	
	dev.cb_cookie = (void *) &dev;
	
	Curve cs[sizearr(svg)/8];
	for(i = 0; i < sizearr(cs); ++i) {
		Curve *c = cs + i;
		for(j = 0; j < 4; ++j) {
			Point *p = c->p + j;
			p->x = svg[8*i + 2*j + 0];
			p->y = svg[8*i + 2*j + 1];
		}
	}
	
#ifdef __REALTIME__
	struct sched_param param;
	param.sched_priority = 80;
	pthread_setschedparam(pthread_self(), SCHED_FIFO, &param);
#endif // __REALTIME__
	
	double t = 0.0;
	struct timespec lts;
	double speed = 1.0; //0.2; // V/s
	long delay = 10000000; // ns
	
	long ns;
	long counter = 0;
	
	float mag = 0.12;
	Point center;
	center.x = -1.6;
	center.y = -0.6;
	
	clock_gettime(CLOCK_MONOTONIC, &lts);
	while(!done) {
		struct timespec ts;
		double dt;
		
		int k = (int) t;
		Curve *c = cs + k;
		float f = t - k;
		Point p = get_pos(c, f);
		p = padd(pmul(p, mag), center);
#ifdef __PRINT__
		printf("%f %f %f\n", p.x, p.y, t);
#endif
		
		KOZ_DACWriteProp wp;
		wp.use_code = 0;
		
		// X channels
		{
			// bottom
			wp.voltage = p.x; // path.x;
			wp.channel_number = 2;
			if(KOZ_dacWrite(&dev, &wp) != 0) {
				fprintf(stderr, "error dac write\n");
				return 2;
			}
			
			wp.voltage = 0.0; //-(path.x + 0.13);
			wp.channel_number = 4;
			if(KOZ_dacWrite(&dev, &wp) != 0) {
				fprintf(stderr, "error dac write\n");
				return 2;
			}
		}
		
		// Y channels
		{
			// right
			wp.voltage = p.y; // path.y;
			wp.channel_number = 3;
			if(KOZ_dacWrite(&dev, &wp) != 0) {
				fprintf(stderr, "error dac write\n");
				return 2;
			}
			
			wp.voltage = 0.0; //-(path.y + 0.02);
			wp.channel_number = 5;
			if(KOZ_dacWrite(&dev, &wp) != 0) {
				fprintf(stderr, "error dac write\n");
				return 2;
			}
		}
		
		clock_gettime(CLOCK_MONOTONIC, &ts);
		ns = get_ns_diff(&ts, &lts);
		
		if(ns < delay) {
			ts.tv_sec = 0;
			ts.tv_nsec = delay - ns;
			nanosleep(&ts, NULL);
		}
		
		clock_gettime(CLOCK_MONOTONIC, &ts);
		ns = get_ns_diff(&ts, &lts);
		lts = ts;
		
		dt = 1e-9*ns;
		double dpar = speed*dt;
		
		t = step(cs, sizearr(cs), t, dpar);
		if(t < 0 || t >= sizearr(cs)) {
			t = 0.0;
			// done = 1;
		}
		
		++counter;
	}
	
#ifdef __REALTIME__
	pthread_setschedparam(pthread_self(), SCHED_OTHER, &param);
#endif // __REALTIME__
	
	CAN_destroyNode(&node);
	
	printf("done in %ld steps\n", counter);
	
	printf("exiting...\n");
	
	return 0;
}
